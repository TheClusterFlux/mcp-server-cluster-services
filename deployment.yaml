apiVersion: v1
kind: ServiceAccount
metadata:
  name: mcp-server-cluster-services
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mcp-server-reader
rules:
- apiGroups: [""]
  resources: ["services", "pods", "endpoints"]
  verbs: ["get", "list"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mcp-server-reader-binding
subjects:
- kind: ServiceAccount
  name: mcp-server-cluster-services
  namespace: default
roleRef:
  kind: ClusterRole
  name: mcp-server-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-server-cluster-services
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mcp-server-cluster-services
  template:
    metadata:
      labels:
        app: mcp-server-cluster-services
    spec:
      serviceAccountName: mcp-server-cluster-services
      containers:
        - name: mcp-server-cluster-services
          image: docker.io/keanuwatts/theclusterflux:mcp-server-cluster-services
          imagePullPolicy: Always
          # MCP servers use stdio, so no ports needed
          # stdin, stdout, stderr are automatically available
          stdin: true
          tty: false
      imagePullSecrets:
        - name: dockerhub-secret
# NOTE: MCP servers communicate via stdio, not HTTP
# To use this server, you have two options:
#
# Option 1: Run locally and connect to cluster via kubeconfig
#   - Build: docker build -t docker.io/keanuwatts/theclusterflux:mcp-server-cluster-services .
#   - Run locally: npm install && npm run build && npm start
#   - Configure Cursor to use the local process
#
# Option 2: Run in-cluster and access via kubectl exec
#   - Deploy this to your cluster
#   - Access via: kubectl exec -it deployment/mcp-server-cluster-services -- node dist/index.js
#   - Or use kubectl port-forward if you create a wrapper service
#
# The Service and Ingress below are optional and not used for MCP communication
# They're kept in case you want to add an HTTP wrapper in the future
---
apiVersion: v1
kind: Service
metadata:
  name: mcp-server-cluster-services
spec:
  selector:
    app: mcp-server-cluster-services
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
  # ClusterIP: None  # Uncomment for headless service if needed
